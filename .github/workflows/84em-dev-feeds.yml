name: "84em.dev: Feed Validation"

on:
  push:
    branches: [main]
    paths:
      - '84em.dev/content/**'
      - '84em.dev/layouts/**'
      - '84em.dev/hugo.toml'
      - '.github/workflows/84em-dev-feeds.yml'
  pull_request:
    types: [labeled]
    branches: [main]
  workflow_dispatch:

defaults:
  run:
    working-directory: 84em.dev

jobs:
  validate-feeds:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || contains(github.event.pull_request.labels.*.name, 'run-ci')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build site
        run: hugo --minify

      - name: Validate RSS feed
        id: rss
        run: |
          if [ ! -f "public/index.xml" ]; then
            echo "ERROR: RSS feed not found"
            echo "rss_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if xmllint --noout public/index.xml 2>/dev/null; then
            echo "RSS feed is well-formed XML"
            echo "rss_valid=true" >> $GITHUB_OUTPUT
          else
            echo "RSS feed is NOT well-formed XML"
            echo "rss_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate sitemap
        id: sitemap
        run: |
          if [ ! -f "public/sitemap.xml" ]; then
            echo "ERROR: Sitemap not found"
            echo "sitemap_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if xmllint --noout public/sitemap.xml 2>/dev/null; then
            echo "Sitemap is well-formed XML"
            echo "sitemap_valid=true" >> $GITHUB_OUTPUT
          else
            echo "Sitemap is NOT well-formed XML"
            echo "sitemap_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const rssValid = '${{ steps.rss.outputs.rss_valid }}' === 'true';
            const sitemapValid = '${{ steps.sitemap.outputs.sitemap_valid }}' === 'true';

            let comment = '## Feed Validation Results (84em.dev)\n\n';
            comment += '| Feed | Status |\n';
            comment += '|------|--------|\n';
            comment += '| RSS (index.xml) | ' + (rssValid ? ':white_check_mark: Valid' : ':x: Invalid') + ' |\n';
            comment += '| Sitemap (sitemap.xml) | ' + (sitemapValid ? ':white_check_mark: Valid' : ':x: Invalid') + ' |\n';

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Fail if feeds invalid
        if: steps.rss.outputs.rss_valid != 'true' || steps.sitemap.outputs.sitemap_valid != 'true'
        run: exit 1
