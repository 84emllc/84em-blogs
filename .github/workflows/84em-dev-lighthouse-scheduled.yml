name: "84em.dev: Scheduled Lighthouse"

on:
  schedule:
    - cron: '0 7 * * 1'  # Every Monday at 7 AM UTC
  workflow_dispatch:

defaults:
  run:
    working-directory: 84em.dev

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://84em.dev/
            https://84em.dev/about/
            https://84em.dev/posts/
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./84em.dev/lighthouserc.json

      - name: Check scores and create issue if needed
        uses: actions/github-script@v7
        with:
          script: |
            const results = ${{ steps.lighthouse.outputs.manifest }};
            const links = ${{ steps.lighthouse.outputs.links }};

            // Calculate median scores
            const byUrl = {};
            for (const result of results) {
              const url = new URL(result.url).pathname || '/';
              if (!byUrl[url]) byUrl[url] = [];
              byUrl[url].push(result.summary);
            }

            const median = arr => {
              const sorted = [...arr].sort((a, b) => a - b);
              const mid = Math.floor(sorted.length / 2);
              return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            };

            let hasIssue = false;
            let issueDetails = [];

            for (const [url, runs] of Object.entries(byUrl)) {
              const perf = Math.round(median(runs.map(r => r.performance)) * 100);
              const a11y = Math.round(median(runs.map(r => r.accessibility)) * 100);

              if (perf < 80) {
                hasIssue = true;
                issueDetails.push('- ' + url + ': Performance score ' + perf + '% (threshold: 80%)');
              }
              if (a11y < 90) {
                hasIssue = true;
                issueDetails.push('- ' + url + ': Accessibility score ' + a11y + '% (threshold: 90%)');
              }
            }

            if (hasIssue) {
              const title = '84em.dev: Lighthouse scores below threshold';

              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'lighthouse,84em.dev'
              });

              let body = '## Lighthouse Performance Alert (84em.dev)\n\n';
              body += 'Weekly Lighthouse check found scores below threshold:\n\n';
              body += issueDetails.join('\n');
              body += '\n\n### Full Results\n\n';
              body += '| Page | Performance | Accessibility | Best Practices | SEO |\n';
              body += '|------|-------------|---------------|----------------|-----|\n';

              for (const [url, runs] of Object.entries(byUrl)) {
                const perf = Math.round(median(runs.map(r => r.performance)) * 100);
                const a11y = Math.round(median(runs.map(r => r.accessibility)) * 100);
                const bp = Math.round(median(runs.map(r => r['best-practices'])) * 100);
                const seo = Math.round(median(runs.map(r => r.seo)) * 100);
                body += '| ' + url + ' | ' + perf + ' | ' + a11y + ' | ' + bp + ' | ' + seo + ' |\n';
              }

              const reportLinks = Object.values(links).slice(0, 3);
              body += '\n[View reports](' + reportLinks.join(') | [Report](') + ')';
              body += '\n\n---\n';
              body += '*Generated by workflow run #' + context.runNumber + '*';

              if (issues.data.length > 0) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues.data[0].number,
                  body: body
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['lighthouse', '84em.dev']
                });
              }
            }
